<html>
  <head>
    <title>Watch That Sound Experiments</title>
    <script type="text/javascript">
      
      async function makeRecorder(targetAudio) {
        const audioSettings = {
          echoCancellation: false,
          autoGainControl: false,
          noiseSuppression: false,
        };
        if (window.inputDevice) {
          audioSettings.deviceId = { exact: window.inputDevice.deviceId };
        }
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: audioSettings,
        });

        const recorder = new MediaRecorder(stream);

        const onRecordingReady = (e) => {
          targetAudio.src = URL.createObjectURL(e.data);
        };
        // listen to dataavailable, which gets triggered whenever we have
        // an audio blob available
        recorder.addEventListener("dataavailable", onRecordingReady);
        return recorder;
      }
  
      const recorders = [];
      function setupRecorders() {
        let recorderContainers = document.querySelectorAll(".recorder_container");
        if (!recorderContainers.length) {
          return;
        }

        recorderContainers.forEach(async (rec) => {
          let start = rec.querySelector(".recorder_start");
          let stop = rec.querySelector(".recorder_stop");
          let play = rec.querySelector(".recorder_play");
          let playstop = rec.querySelector(".recorder_playstop");
          let reset = rec.querySelector(".recorder_reset");
          let audio = rec.querySelector(".recorder_audio");
          const recplay = { audio };
          recorders.push(recplay);
          recplay.recorder = await makeRecorder(audio);

          start.addEventListener("click", async () => {
            start.disabled = true;
            stop.disabled = false;
            activeAudio = audio;
            recplay.recorder.start();
          });
          stop.addEventListener("click", () => {
            stop.disabled = true;
            recplay.recorder.stop();
            play.disabled = false;
            reset.disabled = false;
          });
          play.addEventListener("click", () => {
            if (window.outputDevice) {
              audio.setSinkId(window.outputDevice.deviceId);
            }
            audio.play();
            play.disabled = true;
            playstop.disabled = false;
          });
          playstop.addEventListener("click", () => {
            audio.pause();
            audio.currentTime = 0;
            play.disabled = false;
            playstop.disabled = true;
          });
          reset.addEventListener("click", async  () => {
            play.disabled = true;
            reset.disabled = true;
            start.disabled = false;
            playstop.disabled = true;
            recplay.recorder = await makeRecorder(audio);
          });
          audio.addEventListener("ended", () => {
            play.disabled = false;
            playstop.disabled = true;
          });
        });
      }

      window.addEventListener("DOMContentLoaded", function () {
        setupRecorders();
        document.getElementById("playArecordB").addEventListener("click", () => {
          recorders[0].audio.play();
          recorders[1].recorder.record();
        });
      });
      
    </script>
  </head>
  <body>
    <h1>Experiment: Recording Delay</h1>
    <p>What is the delay when recording audio in browser? First record something in Recorder A.
      (tip: reset after first recording because mic permission delay)</p>
    <div class="recorder_container">
      <h2>Recorder A</h2>
      <button class="recorder_start">Start recording</button>
      <button class="recorder_stop" disabled>Stop recording</button>
      <audio class="recorder_audio" controls></audio>
      <button class="recorder_play" disabled>Play</button>
      <button class="recorder_playstop" disabled>Stop</button>
      <button class="recorder_reset" disabled>Reset</button>
    </div>
    <p>Now: use <button id="playArecordB">Play A + Record B</button> to start playing A and recording into B.</p>
    <div class="recorder_container">
      <h2>Recorder B</h2>
      <button class="recorder_start">Start recording</button>
      <button class="recorder_stop" disabled>Stop recording</button>
      <audio class="recorder_audio" controls></audio>
      <button class="recorder_play" disabled>Play</button>
      <button class="recorder_playstop" disabled>Stop</button>
      <button class="recorder_reset" disabled>Reset</button>
  </div>

    
  </body>
</html>
